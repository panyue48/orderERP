目标：系统逐步实现具备 **企业内控**、**可审计**、**可结账**、**可核销**、**可扩展集成** 的能力。

---

## 0. 当前系统已具备的“可用地基”（Stage1–Stage6）

- **系统地基**：登录/JWT、RBAC、动态菜单、按钮权限（Stage1）
- **基础资料**：商品/仓库/往来单位（Stage2）
- **库存账本**：库存表 + 锁定库存 + 库存流水 + 盘点调账（Stage3）
- **采购域闭环**：分批收货 + 质检门禁 + 退货 + AP 对账/付款/发票 + 对账单锁定（Stage4）
- **销售域闭环**：锁库 + 分批发货 + 发货冲销 + 退货（关联原发货批次 + 退货质检）+ AR 对账/收款/发票 + 对账单锁定（Stage5）
- **资金域 P0**：资金账户 + 收付款流水，且已与 AP/AR 的登记付款/收款打通；补齐手工收付款、资金调拨（Stage6）

> 目前已经可以支撑单公司/单仓/简单内控的“进销存 + 应收应付 + 资金收付”演示闭环。

---

## 1. 拓展优先级

### P0

#### 1.1 收款/付款“分摊核销”（核心）

现状：你现在是“登记收款/付款 -> 写资金流水 -> 回写 AR/AP 已收/已付金额”。  
企业真实场景：一笔收款可能对应多张 AR（或一张 AR 多笔收款），需要 **核销单** 来做分摊、反核销、追溯。

建议落地：
- 新增 `fin_settlement`（核销单）+ `fin_settlement_detail`（核销明细）
  - 维度：客户/供应商、方向（收/付）、核销日期、状态（草稿/已核销/已作废）
  - 明细：关联 `sal_ar_bill` 或 `pur_ap_bill`，记录本次核销金额
- 核销规则：
  - 支持“部分核销”
  - 支持“反核销/作废核销单”（回滚 AR/AP 已收已付与状态）
- 和资金流水的关系：
  - `fin_payment` 作为“钱的发生”
  - `fin_settlement` 作为“钱核销到哪些单据”

验收标准：
- 能用一笔收款同时结清两张 AR
- 能对同一 AR 分两次收款核销，状态随之变化
- 作废核销单后 AR/AP 金额与状态能正确回滚

#### 1.2 财务期间锁定（结账/反结账）

企业必须有“月结/期间锁定”，否则历史单据可随意改动，账会乱。

建议落地：
- `fin_period`：记录每月是否已结账、结账人、结账时间
- 约束：
  - 结账期间内禁止新增/作废影响库存/资金的单据（或只能红冲）
  - 结账后只允许通过“红冲单/冲销单”更正

验收标准：
- 结账后同月 AR/AP/资金相关写操作被禁止，提示明确

---

### P1（业务真实性增强：WMS 与企业内控）

#### 1.3 数据权限升级：从“按钮权限”到“数据权限”

企业里同角色不同人能看见的数据范围不同。

建议落地（最小实现）：
- 用户 -> 可见仓库列表
- 用户 -> 可见客户/供应商列表
- 所有列表查询在 Repository 层增加 `warehouse_id in (...)` / `partner_id in (...)` 过滤

验收标准：
- A 用户看不到 B 用户不可见仓库的库存/单据

#### 1.4 仓内作业：拣货/复核/打包/出库（销售）

销售出库真实流程往往不是“点击发货=立即扣库”。

建议落地：
- `wms_pick`（拣货单）-> `wms_pack`（打包单）-> `wms_ship`（出库确认）
- 扣库时点放在“出库确认”，而不是“创建出库单”

验收标准：
- 可追溯谁拣货、谁复核、谁确认出库

#### 1.5 批次/效期/序列号（库存粒度更细）

适用行业：食品/医药/3C。

建议落地：
- `wms_stock_batch`：按批次/效期管理库存
- 出库策略：FIFO/FEFO（先进先出/先过期先出）

验收标准：
- 能追溯“某次销售出库用了哪些入库批次”

---

### P2（税务与经营报表）

#### 1.6 税与发票体系升级（价税分离/红票）

现状：发票为“登记金额”，缺税率/税额/未税。

建议落地：
- AR/AP 发票表增加：税率、未税金额、税额、价税合计
- 支持红字发票（冲销）

验收标准：
- 报表可按税率汇总税额

#### 1.7 报表体系（老板/财务最常用）

建议落地：
- 应收/应付账龄（0–30/31–60/…）
- 库存周转、滞销预警
- 毛利报表（按客户/商品/月份）
- 资金日报（按账户）

---

### P3（工程化：可靠性、可观测性、可集成）

#### 1.8 幂等键统一 & Outbox

把关键写路径统一为：
- `request_no`（前端生成/后端透传）唯一约束
- Outbox 事件表：写库与发消息解耦

#### 1.9 审计日志与风控

- `sys_audit_log`：记录关键动作（谁在何时对哪张单做了什么）
- 高危动作二次确认/审批

#### 1.10 对接能力

- 对接电商订单/OMS、物流、电子发票、财务软件
- 建议用 Webhook 或消息队列（后续）

---

## 2. 推荐迭代顺序（实操）

1) **核销分摊（1.1）**：最“企业化”的财务能力，能显著提升真实性
2) **期间锁定（1.2）**：保证账务稳定与可审计
3) **数据权限（1.3）**：解决“多岗位多仓协作”的现实问题
4) **仓内作业（1.4）**：让 WMS 更贴近仓库实际流程
5) **批次效期（1.5）**：从“账本”升级到“可追溯库存”
6) **税务/报表（1.6/1.7）**：面向财务与老板的日常管理
7) **工程化（1.8–1.10）**：面向上线与长期维护

---



