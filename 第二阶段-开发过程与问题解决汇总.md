# 第二阶段：基础数据（Base Data）开发过程与问题解决汇总

本文汇总 **OrderERP 第二阶段（基础资料）** 的实际开发内容（含扩展/优化），以及本阶段开发中遇到的主要问题、现象、根因与最终解决方案。  
适用范围：`V4 ~ V7`（Flyway 迁移）、基础资料 CRUD、图片上传、Excel 导入导出、前端交互与工程化优化。

---

## 一、第二阶段开发过程（实现内容 + 扩展优化）

### 1. 目标与交付

第二阶段目标是补齐 ERP 运行所需的“静态基础资料”，并保证：

- 数据表结构可被版本化管理（Flyway）。
- 基础资料可在前端完整 CRUD。
- 导入导出可用（EasyExcel）。
- 权限能控制到“页面/按钮/导入导出”等粒度。

对应的最终交付：

- **基础资料模块**：商品、仓库、往来单位、商品分类（新增）。
- **Excel 导入导出**：商品/仓库/往来单位/分类四类数据的导出、导入模板、导入。
- **权限体系补齐**：页面权限 + 按钮级权限 + 导入/导出权限。
- **工程化优化**：前端 chunk 拆分、Vite 代理稳定性、下载体验优化、后端错误可观测性增强。

---

### 2. 数据库（Flyway 迁移结构与数据种子）

本阶段主要由以下迁移文件驱动（位于 `backend/src/main/resources/db/migration/`）：

- `V4__base_data.sql`
  - 创建基础资料表：`base_product`、`base_warehouse`、`base_partner`
  - 插入“基础资料”菜单与路由映射（`sys_menu`），并为角色授权（`sys_role_menu`）
  - 兼容已存在库：`create table if not exists` + 使用 `information_schema` 进行“缺列补齐”（例如 `base_product.image_url`）
- `V5__base_data_permissions.sql`
  - 补齐基础资料模块的按钮级权限（新增/编辑/删除等）并进行角色授权
- `V6__base_product_categories.sql`
  - 新增商品分类表 `base_product_category`
  - 给 `base_product.category_id` 增加索引（通过 `information_schema.statistics` 判断并动态创建）
  - 增加“商品分类”菜单与按钮权限并授权
- `V7__base_excel_permissions.sql`
  - 增加“导出/导入”权限点：
    - `base:*:export`、`base:*:import`
  - 角色授权策略：
    - `admin(role_id=1)`：导入 + 导出
    - `manager(role_id=2)`：仅导出（只读）

这套设计保证：**数据库结构 + 初始菜单/权限** 可以随代码启动自动落库，避免人工 SQL 同步。

---

### 3. 后端（基础资料 CRUD + Excel 导入导出）

#### 3.1 基础资料 CRUD（JPA）

模块目录：`backend/src/main/java/com/ordererp/backend/base/`

已实现实体/仓储/服务/控制器：

- 商品：`BaseProduct*`
- 仓库：`BaseWarehouse*`
- 往来单位：`BasePartner*`
- 商品分类：`BaseProductCategory*`

接口特征（以商品为例，实际四类一致）：

- 列表分页：`GET /api/base/products`
- 详情：`GET /api/base/products/{id}`
- 下拉选项：`GET /api/base/products/options`
- 新增/编辑/删除：`POST/PUT/DELETE`
- 接口均通过 `@PreAuthorize` 进行权限控制（例如 `base:product:view/add/edit/remove`）。

#### 3.2 软删除与唯一性冲突的处理（重要扩展）

基础资料表存在 `deleted` 逻辑删除字段，同时又需要维持编码唯一（如 `product_code/warehouse_code/partner_code/category_code`）。  
为避免“删除后无法重新创建同编码”的用户体验问题，本阶段在 service 层实现了策略：

- **如果发现同编码记录已被逻辑删除**：不报错，而是“复活并更新”该记录（将 `deleted` 置回 `0`，并更新其它字段）。

涉及文件（代表性）：

- `backend/src/main/java/com/ordererp/backend/base/service/BaseProductService.java`
- `backend/src/main/java/com/ordererp/backend/base/service/BaseWarehouseService.java`
- `backend/src/main/java/com/ordererp/backend/base/service/BasePartnerService.java`
- `backend/src/main/java/com/ordererp/backend/base/service/BaseProductCategoryService.java`

#### 3.3 Excel 导入导出（EasyExcel）

依赖：

- `backend/pom.xml`：引入 `com.alibaba:easyexcel:3.3.4`

核心实现：

- Excel 行模型：`backend/src/main/java/com/ordererp/backend/base/excel/*.java`
- 统一业务实现：`backend/src/main/java/com/ordererp/backend/base/service/BaseExcelService.java`
- 响应头工具：`backend/src/main/java/com/ordererp/backend/common/util/ExcelHttpUtil.java`

导出/模板/导入接口（四类基础资料均已实现）：

- 商品：`/api/base/products/export`、`/import-template`、`/import`
- 仓库：`/api/base/warehouses/export`、`/import-template`、`/import`
- 往来单位：`/api/base/partners/export`、`/import-template`、`/import`
- 分类：`/api/base/categories/export`、`/import-template`、`/import`

权限点：

- 导出：`base:*:export`
- 导入：`base:*:import`

导入结果统一返回：

- `backend/src/main/java/com/ordererp/backend/common/dto/ImportResult.java`
  - 统计：`inserted/updated/failed` + 明细错误行信息（用于前端提示）。

---

### 4. 前端（页面、交互、下载体验与工程化）

#### 4.1 基础资料页面与权限联动

页面：

- `frontend/src/views/BaseProducts.vue`
- `frontend/src/views/BaseWarehouses.vue`
- `frontend/src/views/BasePartners.vue`
- `frontend/src/views/BaseCategories.vue`

前端通过 `auth.hasPerm(...)` 进行按钮级展示控制，确保：

- 无权限用户看不到“新增/编辑/删除/导入/导出/模板”等按钮；
- 与后端 `@PreAuthorize` 双重兜底一致。

#### 4.2 Excel 下载/导入 API 封装与错误解析

封装文件：

- `frontend/src/api/base-excel.ts`

关键实现点：

- 下载使用 `responseType: 'blob'`，并开启 `validateStatus: () => true`
  - 目的：即使后端返回 403/500 的 JSON（Blob），也能解析出 `message` 并提示给用户，而不是直接“下载失败”。
- 延迟 `URL.revokeObjectURL`
  - 避免 Chrome/Edge 下载条出现“失败”（实际是 blob URL 被过早回收导致）。

#### 4.3 导出/模板失败提示改为更明显的位置（交互优化）

为避免“失败提示出现在左下角不明显”，本阶段将基础资料页面的导出/模板交互调整为：

- 点击后显示 `ElLoading.service(...)`（全屏遮罩）
- 成功/失败使用 `ElNotification`（右上角明显提示）

涉及文件：

- `frontend/src/views/BaseProducts.vue`
- `frontend/src/views/BaseWarehouses.vue`
- `frontend/src/views/BasePartners.vue`
- `frontend/src/views/BaseCategories.vue`

#### 4.4 前端构建体积与加载优化（CHUNKSIZE）

已记录于：`CHUNKSIZE优化记录.md`  
对应配置：`frontend/vite.config.ts`

核心做法：

- 通过 `rollupOptions.output.manualChunks` 拆分稳定 vendor chunk（element-plus / vue-router / pinia / axios 等）
- 降低单个 chunk 体积，提升浏览器缓存命中率，减轻首屏加载压力

#### 4.5 Vite 代理稳定性

配置：`frontend/vite.config.ts`

- `/api` 与 `/uploads` 代理目标使用 `127.0.0.1`（IPv4），避免 Windows/Node 将 `localhost` 解析为 IPv6 `::1` 时出现间歇性 `ECONNREFUSED`。

---

### 5. 后端稳定性与可观测性增强（扩展优化）

#### 5.1 Excel 依赖缺失的“启动期失败”保护

文件：

- `backend/src/main/java/com/ordererp/backend/config/ExcelDependencyGuardConfig.java`

作用：

- 如果后端以“IDE 旧 classpath（缺少 EasyExcel）”启动，会在启动期直接抛出明确异常并终止启动，
  避免“能启动但点导出就 500”的隐蔽问题。

#### 5.2 全局异常统一返回 message（便于前端展示）

文件：

- `backend/src/main/java/com/ordererp/backend/common/exception/GlobalExceptionHandler.java`

作用：

- 统一输出包含 `message` 的 JSON，前端能直接展示真实错误原因。
- 未处理异常会在后端日志打印堆栈，定位更快。

#### 5.3 Spring Boot 错误信息输出（开发期）

配置：

- `backend/src/main/resources/application.yml`
  - `server.error.include-message: always`
  - `server.error.include-exception: true`
  - `server.error.include-stacktrace: on_param`

目的：

- 开发调试阶段让错误信息更“可见”，减少“只有 500 没有原因”的排查成本。

---

## 二、第二阶段开发遇到的问题（详细描述 + 最终解决办法）

以下为本阶段真实遇到的核心问题集合（按影响与频率归纳）。

---

### 问题 1：Flyway 在非空 schema 上启动失败（无 schema history 表）

**现象**  
启动报错：

- `Found non-empty schema(s) ... but no schema history table`

**根因**  
数据库里已经有表，但 `flyway_schema_history` 不存在，Flyway 默认认为这是一个“未受管理但非空”的库，拒绝直接迁移。

**最终解决办法**  
二选一（本项目采用的是“配置允许” + “必要时清空重建”思路）：

- 开发环境允许 baseline：在 `application.yml` 中启用 `spring.flyway.baselineOnMigrate=true`（或等效配置），让 Flyway 先建立历史表再执行迁移；  
- 或者直接清空目标 schema（尤其是测试库），再由 Flyway 从 `V1` 开始完整迁移。

---

### 问题 2：迁移跑到了错误的数据库（blog_db vs erp_data）

**现象**  
后端启动/迁移看似成功，但实际表建在了 `blog_db`，`erp_data` 为空，导致前端查不到任何数据。

**根因**  
`spring.datasource.url` 指向了错误的 schema，Flyway 与业务数据自然都落在同一个错误库中。

**最终解决办法**  

- 将 `backend/src/main/resources/application.yml` 中 datasource URL 明确指向 `erp_data`；
- 并在启动日志中打印最终连接到的数据库（用于快速发现指错库）。

---

### 问题 3：MySQL 不支持 `CREATE INDEX IF NOT EXISTS` 导致迁移失败

**现象**  
执行 `V1__init.sql` 时出现：

- `SQLSyntaxErrorException ... near 'if not exists ...'`

**根因**  
MySQL 对 `CREATE INDEX IF NOT EXISTS` 不兼容（不同版本语法差异明显）。

**最终解决办法**  
迁移脚本中统一改为：

- 通过 `information_schema.statistics` 判断索引是否存在；
- 不存在时用动态 SQL 执行 `create index ...`。

代表实现：`V6__base_product_categories.sql` 中对 `idx_base_product_category_id` 的处理方式。

---

### 问题 4：导出/模板接口 500（后端日志没有根因，前端只看到“导出失败”）

**现象**  
前端点击导出：

- `GET /api/base/products/export 500 (Internal Server Error)`

后端只看到过滤器链日志，缺少异常消息，排查困难。

**根因（组合问题）**  

1) IDE 启动的后端使用了“旧 classpath”，运行时并未加载 EasyExcel 依赖，导致导出写 Excel 时抛异常；  
2) 前端下载走 blob，后端默认错误结构/前端未解析 message，导致只显示泛化的“失败”。

**最终解决办法**  

- 后端：
  - `backend/pom.xml` 引入 EasyExcel；
  - 增加 `ExcelDependencyGuardConfig`：启动期检查 `com.alibaba.excel.EasyExcel` 是否存在；
  - 增加 `GlobalExceptionHandler`：统一返回含 `message` 的 JSON，并在日志中打印异常堆栈；
  - 开发期打开 `server.error.include-message` 等配置便于定位。
- 前端：
  - `frontend/src/api/base-excel.ts` 对 blob 错误 JSON 做解析（`validateStatus` + `blob.text()` + JSON.parse），将 message 透传给用户。

---

### 问题 5：浏览器下载条显示“失败”（但接口其实已经返回）

**现象**  
点击“导出/模板”后，浏览器左下角下载条提示失败，用户误以为功能不可用。

**根因**  
`URL.revokeObjectURL` 回收太快，部分浏览器在文件尚未真正写入下载任务时 blob URL 已失效。

**最终解决办法**  

- 在 `frontend/src/api/base-excel.ts` 中延迟回收 blob URL（例如 30 秒后再 revoke）。

---

### 问题 6：导出/模板失败提示位置不明显（左下角一闪而过）

**现象**  
用户点击导出后只在左下角出现短暂错误提示，不易发现，也无法明确知道原因。

**根因**  
页面使用 `ElMessage` 提示，位置与时长在该交互下不合适；同时 blob 错误信息未解析时提示过于泛化。

**最终解决办法**  

- 基础资料页面的导出/模板交互统一改为：
  - `ElLoading.service`（过程可见）
  - `ElNotification`（右上角、可读性更强）
- 并通过 `errText(...)` 把后端 message 展示出来。

涉及文件：

- `frontend/src/views/BaseProducts.vue`
- `frontend/src/views/BaseWarehouses.vue`
- `frontend/src/views/BasePartners.vue`
- `frontend/src/views/BaseCategories.vue`

---

### 问题 7：同编码数据被逻辑删除后无法重新创建

**现象**  
删除某条商品/仓库/往来单位后，再用同编码创建会失败（唯一约束冲突）。

**根因**  
数据库唯一索引不区分 `deleted`，逻辑删除并不会释放唯一值。

**最终解决办法**  
service 层做“复活策略”：

- 新增时如果发现同编码记录 `deleted=1`，则改为更新并把 `deleted` 置回 `0`。

---

### 问题 8：Vite 代理 `ECONNREFUSED`（/api/auth/login 等接口间歇性失败）

**现象**  
Vite 控制台出现：

- `http proxy error ... ECONNREFUSED`

**根因**  
Windows/Node 对 `localhost` 的解析可能走 IPv6 `::1`，而后端实际监听在 IPv4/或监听策略不同，导致连接被拒绝或不稳定。

**最终解决办法**  

- `frontend/vite.config.ts` 代理 target 改为 `http://127.0.0.1:8080`，并同步处理 `/uploads` 静态资源代理。

---

### 问题 9：Maven 打包失败（jar 被占用/无法重命名 .original）

**现象**  
执行 `mvn package` 时：

- Spring Boot repackage 不能把 jar 重命名为 `.original`（Windows 文件锁占用）

**根因**  
正在运行的 `java -jar target/backend-*.jar` 进程占用了 jar 文件，Windows 不允许重命名/覆盖。

**最终解决办法**  

- 停止占用 jar 的进程后再执行 `mvn clean package`。

---

## 附：本阶段关键文件索引（便于回溯）

- 数据库迁移：
  - `backend/src/main/resources/db/migration/V4__base_data.sql`
  - `backend/src/main/resources/db/migration/V5__base_data_permissions.sql`
  - `backend/src/main/resources/db/migration/V6__base_product_categories.sql`
  - `backend/src/main/resources/db/migration/V7__base_excel_permissions.sql`
- 后端基础资料模块：
  - `backend/src/main/java/com/ordererp/backend/base/`
- Excel：
  - `backend/pom.xml`
  - `backend/src/main/java/com/ordererp/backend/base/service/BaseExcelService.java`
  - `backend/src/main/java/com/ordererp/backend/common/util/ExcelHttpUtil.java`
- 后端可观测性：
  - `backend/src/main/java/com/ordererp/backend/config/ExcelDependencyGuardConfig.java`
  - `backend/src/main/java/com/ordererp/backend/common/exception/GlobalExceptionHandler.java`
  - `backend/src/main/resources/application.yml`
- 前端：
  - `frontend/src/api/base-excel.ts`
  - `frontend/src/views/BaseProducts.vue`
  - `frontend/src/views/BaseWarehouses.vue`
  - `frontend/src/views/BasePartners.vue`
  - `frontend/src/views/BaseCategories.vue`
  - `frontend/vite.config.ts`

