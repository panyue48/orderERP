# 第一阶段（System Core）问题与解决方案（详细版）

本文以“问题 -> 现象 -> 根因 -> 解决方案 -> 验证方式”的结构，记录第一阶段开发和联调中真实遇到的问题与最终修复方式。  
范围：后端（Spring Boot 3 / Spring Security / JPA / Flyway / MySQL），前端（Vue3 / Vite / Pinia / Vue Router / Element Plus）。

---

## 1. 开发指南文档乱码

现象：
- `ERP目的/开发指南.md` 打开后中文变成乱码。

根因：
- 文件是 UTF-8，但编辑器/终端按其他编码（例如 GBK）读取。

解决方案：
- 统一以 UTF-8 打开/保存 `ERP记账系统开发指南.md`。

验证方式：
- 重新打开文件，标题/段落中文显示正常。

---

## 2. 后端默认使用 H2 内存库导致数据不持久

现象：
- 每次重启后数据丢失；MySQL 库里没有建表/没有数据。

根因：
- Spring Boot 数据源配置指向 H2：`jdbc:h2:mem:...`。

解决方案：
- 把数据源默认改为 MySQL，并允许用环境变量覆盖：
  - `backend/src/main/resources/application.yml`
  - 使用：`MYSQL_HOST`、`MYSQL_PORT`、`MYSQL_DB`、`MYSQL_USER`、`MYSQL_PASSWORD`

验证方式：
- 启动日志中 JDBC URL 为 `jdbc:mysql://.../erp_data...`。
- MySQL `erp_data` 中出现业务表与 `flyway_schema_history`。

---

## 3. Flyway 报 Unsupported Database: MySQL 8.0

现象：
- 后端启动时抛出：`FlywayException: Unsupported Database: MySQL 8.0`。

根因：
- Flyway 10+ 对部分数据库的支持拆分为独立模块，仅引入 `flyway-core` 不包含 MySQL 支持。

解决方案：
- 增加 MySQL 插件依赖：
  - `backend/pom.xml` 增加 `org.flywaydb:flyway-mysql`

验证方式：
- 后端启动时 Flyway 能识别 MySQL，并开始执行 `db/migration` 的脚本。

---

## 4. Flyway 报 Found non-empty schema but no schema history table

现象：
- 启动时提示某个 schema 非空，但没有 `flyway_schema_history`，要求 baseline 或清库。

根因：
- 目标数据库已存在表（可能是手工导入、或者连错库），Flyway 默认不允许直接在“非空库”初始化迁移历史表。

解决方案：
- 开发环境允许 baseline（让 Flyway 能在非空库初始化历史表）：
  - `backend/src/main/resources/application.yml`
    - `spring.flyway.baseline-on-migrate: true`
    - `spring.flyway.baseline-version: 0`

验证方式：
- 启动后 MySQL 中出现 `flyway_schema_history`，迁移继续执行。

注意：
- baseline 适合开发联调/已有库的过渡；生产环境建议明确迁移历史策略。

---

## 5. Flyway V1 执行失败（MySQL 不支持 CREATE INDEX IF NOT EXISTS）

现象：
- Flyway 在 V1 执行时报 1064，错误点在 `CREATE INDEX IF NOT EXISTS ...`。

根因：
- MySQL 不支持 `CREATE INDEX IF NOT EXISTS` 语法。

解决方案：
- 把索引声明改为 MySQL 兼容写法（在 `CREATE TABLE` 内声明 index）：
  - `backend/src/main/resources/db/migration/V1__init.sql`

验证方式：
- `ledger_entry` 表成功创建；并能看到索引 `idx_ledger_entry_date` / `idx_ledger_entry_account_code`。

---

## 6. 数据/表跑进了错误的数据库（例如 blog_db）

现象：
- 你以为在 `erp_data`，但实际 Flyway 建表/插入发生在 `blog_db`。
- 结果：`erp_data` 空、`blog_db` 却多了 sys_* 表。

根因：
- `spring.datasource.url` 或环境变量/IDE 启动参数覆盖了库名（`MYSQL_DB`），导致连接到了错误 schema。

解决方案：
- 增加启动时“连接库校验 + fail-fast”：
  - `backend/src/main/java/com/ordererp/backend/config/DatabaseGuardConfig.java`
  - `backend/src/main/resources/application.yml`
    - `app.datasource.expected-database: erp_data`
    - `app.datasource.fail-on-mismatch: true`
- 该校验会在 Flyway 迁移前/应用启动后打印：URL / user / 实际 db，并在不一致时直接阻止启动。

验证方式：
- 启动日志出现：
  - `Database connection before flyway migrate: ... db='erp_data'`
  - `Database connection after application start: ... db='erp_data'`
- 若连错库会直接报错并退出，避免写错库。

---

## 7. 登录后仍显示“占位页”（菜单 component 映射缺失或被覆盖）

现象：
- 登录成功，但点击“概览/记账/系统管理”进入的页面显示“第一阶段占位状态”。

根因：
- 前端动态路由依赖后端返回的 `sys_menu.component` 字段来映射组件。
- 若导入了旧 `erp_data.sql` 或菜单数据没有 `component`，前端会落到 `Placeholder.vue`。

解决方案：
- 通过迁移/初始化确保 `sys_menu.component` 有值且与前端映射一致：
  - 例如：`views/Dashboard.vue`、`views/Ledger.vue`、`views/Profile.vue`、`views/SystemUsers.vue`、`views/SystemRoles.vue`
- 迁移修正菜单 component：
  - `backend/src/main/resources/db/migration/V3__system_user_role_pages.sql`

验证方式：
- 调用 `/api/system/menu/routers`，返回的路由项 `component` 与前端映射表一致。
- 点击菜单能进入真实页面而不是占位页。

---

## 8. 动态路由已添加，但页面仍停留在 NotFound/占位页（需刷新才恢复）

现象：
- 首次访问 `/dashboard` 等页面时，先匹配到 `NotFound`；
- 动态路由加载完成后，仍停在 NotFound（占位页），必须手动刷新才正常。

根因：
- 路由守卫在动态路由添加后 `return { ...to, replace: true }`，把 `to.name = 'NotFound'` 的匹配状态也带回去，导致仍按 NotFound 渲染。

解决方案：
- 动态路由添加后，重新用 path 触发一次匹配：
  - `frontend/src/router/index.ts`
  - `return { path: to.fullPath, replace: true }`

验证方式：
- 首次登录后进入任意页面不需要手动刷新。

---

## 9. 系统管理子页面空白（child path 以 / 开头导致嵌套渲染异常）

现象：
- 菜单能点，但渲染区域空白；或路由行为不稳定。

根因：
- Vue Router：添加到父路由的 children 时，child 的 path 若以 `/` 开头，会被当作“绝对路径”，导致嵌套层级/匹配行为异常。

解决方案：
- 动态路由构建时，把要挂到 `Root` 下的 child path 统一转换为相对 path：
  - `frontend/src/router/dynamic.ts`

验证方式：
- “系统管理/个人信息/用户管理/角色管理”都能在主布局中正确渲染。

---

## 10. 点击“系统管理(目录)”本身进入空白

现象：
- 点“系统管理”这一行（目录）进入 `/system`，页面空白。

根因：
- `/system` 对应 `RouteView`，但没有默认 child 匹配时就没有内容显示。

解决方案：
- 对有 children 的目录路由自动加 redirect 到第一个子路由：
  - `frontend/src/router/dynamic.ts`

验证方式：
- 点击“系统管理”会自动跳到“个人信息”（或第一个子菜单），不再空白。

---

## 11. 系统管理下拉栏子栏目全部空白（RouteView 未正确渲染 RouterView）

现象：
- 系统管理展开后点击任意子菜单都空白。
- 控制台可能只剩一些 Router warn，但没有明显报错。

根因：
- `RouteView` 用渲染函数写成 `h('router-view')`，在 Vue3 中可能被当作普通字符串标签/自定义元素，而不是 `RouterView` 组件，导致子路由不渲染。

解决方案：
- 使用真正的 `RouterView` 组件：
  - `frontend/src/router/routeView.ts`
  - `return () => h(RouterView)`

验证方式：
- “个人信息/用户管理/角色管理”能渲染出具体内容。

---

## 12. 二次打开浏览器直接“自动登录”（未退出也自动生效）

现象：
- 第一次登录后即使没点退出，第二次打开页面会直接进入系统。
- 用户希望：默认不要自动登录；但可以提供“保持登录状态”选项。

根因：
- 早期实现把 token/user 永久写入 localStorage，浏览器再次打开仍会带 token，从而直接认为已登录。

解决方案：
- 增加两个选项并实现对应逻辑：
  - 记住密码：仅回填用户名/密码（本地存储）
  - 保持登录状态：决定 token/user 是否持久化
- 文件：
  - `frontend/src/views/Login.vue`
  - `frontend/src/stores/auth.ts`
  - `frontend/src/auth/session.ts`
  - `frontend/src/api/http.ts`
  - `frontend/src/main.ts`
- 默认不保持登录：启动时会清理遗留 token，防止“上个版本残留 token 导致自动登录”。

验证方式：
- 不勾选“保持登录状态”：刷新/重启后要求重新登录。
- 勾选“保持登录状态”：刷新/重启后仍保持登录。

---

## 13. 登录后左侧菜单偶发不显示（必须刷新才出现）

现象：
- 登录成功进入页面，但侧边栏菜单是空的；刷新后才出现。

根因：
- 菜单数据是异步加载；某些时序（尤其 dev/HMR 或边界导航）会导致布局先渲染但菜单还没加载。

解决方案：
- 在布局层增加兜底：只要“已登录且 menus 未加载”，就主动 loadMenus：
  - `frontend/src/layouts/MainLayout.vue`
- 路由守卫按 `auth.menusLoaded` 控制动态路由添加，避免重复/漏添加：
  - `frontend/src/router/index.ts`

验证方式：
- 多次刷新/重新登录后，侧边栏稳定显示菜单，不依赖手动刷新。

---

## 14. 初始账号密码 + 明文密码兼容

现象：
- 需要一组默认用户能直接登录。
- 同时历史数据（例如导入脚本）可能把 password 存成明文 `123456`，而 Spring Security 默认期望 `{id}` 前缀（如 `{bcrypt}`）。

根因：
- `DelegatingPasswordEncoder` 要求密码存储格式带 `{noop}/{bcrypt}` 前缀，否则可能无法匹配。

解决方案：
- 初始化用户：`admin/manager/staff`，默认密码 `123456`：
  - `backend/src/main/resources/db/migration/V1__init.sql`
- 兼容明文：若数据库密码不以 `{` 开头，按 `{noop}` 处理：
  - `backend/src/main/java/com/ordererp/backend/system/security/SysUserDetailsService.java`
- 新创建/改密码统一用 `PasswordEncoder`（bcrypt）：
  - `backend/src/main/java/com/ordererp/backend/system/service/SysAdminUserService.java`
  - `backend/src/main/java/com/ordererp/backend/system/service/SysUserService.java`

验证方式：
- `admin/123456` 能登录。
- 新建用户后密码入库为 `{bcrypt}...` 且可登录。

---

## 15. Spring Data PageImpl 序列化告警

现象：
- 后端日志出现：
  - `Serializing PageImpl instances as-is is not supported...`

根因：
- 直接返回 `Page<T>`（PageImpl）时，Spring Data 提醒 JSON 结构可能不稳定。

解决方案：
- 用稳定的分页 DTO 包装返回：
  - 新增：`backend/src/main/java/com/ordererp/backend/common/dto/PageResponse.java`
  - 修改：
    - `backend/src/main/java/com/ordererp/backend/system/controller/SystemUserAdminController.java`
    - `backend/src/main/java/com/ordererp/backend/system/controller/SystemRoleAdminController.java`

验证方式：
- 访问用户/角色分页接口不再输出该告警。

---

## 16. “点击登录/回车都失效 + Vite 代理 ECONNREFUSED”。
改动点（已落盘）：

修复登录页按钮不触发登录：Login.vue 给登录按钮补回 @click="handleLogin"，并加了 if (loading.value) return 防止重复触发。
修复登录页模板异常：Login.vue 把“保持登录状态”的 el-checkbox 结束标签修正为正确的 </el-checkbox>（之前会导致模板结构乱掉，事件绑定也可能异常）。
修复 Vite 代理偶发拒绝连接：vite.config.ts 把 proxy target 从 http://localhost:8080 改为 http://127.0.0.1:8080（Windows/Node 有时会把 localhost 解析到 IPv6 ::1，导致 AggregateError ECONNREFUSED）。

## 17. 第一阶段功能补齐（可用功能清单）

16.1 个人信息（当前用户）
- 后端：
  - `GET /api/system/user/profile`
  - `PUT /api/system/user/profile`
  - `POST /api/system/user/profile/password`
- 前端：
  - `frontend/src/views/Profile.vue`

16.2 用户管理（CRUD + 角色分配）
- 后端：
  - `GET/POST/PUT/DELETE /api/system/users...`
  - 权限：`sys:user:view`
- 前端：
  - `frontend/src/views/SystemUsers.vue`

16.3 角色管理（CRUD + 菜单权限分配）
- 后端：
  - `GET/POST/PUT/DELETE /api/system/roles...`
  - `GET/PUT /api/system/roles/{id}/menus`
  - `GET /api/system/menus`
  - 权限：`sys:role:view`
- 前端：
  - `frontend/src/views/SystemRoles.vue`

16.4 菜单与路由接入
- 菜单 component 修正：
  - `backend/src/main/resources/db/migration/V3__system_user_role_pages.sql`
- 前端组件映射：
  - `frontend/src/router/dynamic.ts`

验证方式：
- 登录后“系统管理”下：
  - 个人信息 / 用户管理 / 角色管理 都能打开并可操作。

---

## 启动与验证（推荐流程）

1) 启动后端
```powershell
cd backend
mvn spring-boot:run
```

2) 启动前端
```powershell
cd frontend
npm run dev
```

3) 登录（默认）
- `admin / 123456`

4) 验证页面
- 概览：`/dashboard`
- 记账：`/ledger`
- 系统管理：
  - 个人信息：`/system/profile`
  - 用户管理：`/system/users`
  - 角色管理：`/system/roles`
